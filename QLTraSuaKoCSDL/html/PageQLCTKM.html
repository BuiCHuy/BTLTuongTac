<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiveH Promotions Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        .peer-sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        input[type="radio"]:checked + .radio-dot { background-color: #7C3AED; border-color: #7C3AED; }
        input[type="radio"]:focus + .radio-dot { outline: 2px solid #C084FC; outline-offset: 2px; }
        .radio-dot { width: 1.25rem; height: 1.25rem; border-radius: 9999px; border: 2px solid #D1D5DB; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .radio-dot-inner { width: 0.375rem; height: 0.375rem; background-color: white; border-radius: 9999px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
<!-- Header -->
<header class="flex items-center justify-between px-6 py-4 bg-white shadow-sm">
    <h1 class="text-3xl font-bold text-indigo-600">FiveH</h1>
    <div class="flex items-center space-x-6">
        <div class="flex items-center space-x-2 cursor-pointer hover:text-indigo-600 transition-colors">
            <i class="fas fa-cog text-gray-600 text-lg"></i>
            <span class="text-gray-700 font-medium">Cài đặt</span>
        </div>
        <div class="flex items-center space-x-3">
            <img src="https://placehold.co/40x40" alt="Profile" class="w-10 h-10 rounded-full border border-gray-300">
            <div class="flex flex-col">
                <span class="text-gray-700 font-medium">Quản lý</span>
                <span class="text-gray-500 text-sm cursor-pointer hover:text-indigo-600">Đăng xuất</span>
            </div>
        </div>
    </div>
</header>

<!-- Navigation -->
<nav class="bg-gradient-to-r from-purple-600 to-rose-500 py-4 px-6 shadow-md">
    <div class="max-w-7xl mx-auto flex justify-between items-center text-white">
        <a href="TrangChu.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors">
            <i class="fas fa-home text-lg"></i>
            <span class="text-lg font-semibold">Trang chủ</span>
        </a>
        <a href="PageQLBH.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors">
            <i class="fas fa-shopping-cart text-lg"></i>
            <span class="text-lg font-semibold">Bán hàng</span>
        </a>
        <a href="PageQLNV.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors">
            <i class="fas fa-users text-lg"></i>
            <span class="text-lg font-semibold">Nhân viên</span>
        </a>
        <a href="PageQLMH.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors">
            <i class="fas fa-box text-lg"></i>
            <span class="text-lg font-semibold">Mặt hàng</span>
        </a>
        <a href="PageQLCTKM.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors text-pink-100">
            <i class="fas fa-tags text-lg"></i>
            <span class="text-lg font-semibold">CT Khuyến mại</span>
        </a>
        <a href="PageQLDT.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors">
            <i class="fas fa-chart-line text-lg"></i>
            <span class="text-lg font-semibold">Doanh thu</span>
        </a>
    </div>
</nav>

<!-- Main Content -->
<main class="max-w-7xl mx-auto mt-8 px-6 animate-fade-in">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">QUẢN LÝ CHƯƠNG TRÌNH KHUYẾN MẠI</h2>
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-4">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên, theo mã" class="h-10 w-96 px-4 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-600">
                <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <button onclick="handleSearch()" class="h-10 bg-purple-600 text-white px-4 py-2 rounded-md shadow-md hover:bg-purple-700 transition-colors flex items-center space-x-2">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <div class="flex space-x-4">
            <button onclick="openModal('filter')" class="bg-purple-600 text-white px-4 py-2 rounded-md shadow-md hover:bg-purple-700 transition-colors flex items-center space-x-2">
                <i class="fas fa-filter"></i>
                <span>Lọc</span>
            </button>
            <button onclick="openModal('add')" class="bg-purple-600 text-white px-4 py-2 rounded-md shadow-md hover:bg-purple-700 transition-colors flex items-center space-x-2">
                <i class="fas fa-plus"></i>
                <span>Thêm mới</span>
            </button>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                <tr class="bg-purple-200 h-12">
                    <th class="px-4 py-2 text-left text-lg font-semibold text-gray-800">Mã CT</th>
                    <th class="px-4 py-2 text-left text-lg font-semibold text-gray-800">Tên CT</th>
                    <th class="px-4 py-2 text-left text-lg font-semibold text-gray-800">Ngày bắt đầu</th>
                    <th class="px-4 py-2 text-left text-lg font-semibold text-gray-800">Ngày kết thúc</th>
                    <th class="px-4 py-2 text-left text-lg font-semibold text-gray-800">Hình thức</th>
                    <th class="px-4 py-2 text-left text-lg font-semibold text-gray-800">Mức giảm giá</th>
                    <th class="px-4 py-2 text-left text-lg font-semibold text-gray-800">Trạng thái</th>
                    <th class="px-4 py-2 text-left text-lg font-semibold text-gray-800">Hành động</th>
                </tr>
                </thead>
                <tbody id="promotionsTableBody"></tbody>
            </table>
        </div>
    </div>
    <div class="flex items-center justify-end mt-4 text-sm text-gray-700 p-4 rounded">
        <button id="prevPage" class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-50 flex items-center gap-1 transition-colors" disabled>
            <i class="fas fa-chevron-left"></i> Trước
        </button>
        <div id="pageButtons" class="flex space-x-2"></div>
        <button id="nextPage" class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-50 flex items-center gap-1 transition-colors">
            Sau <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</main>

<!-- Modals -->
<div id="modalContainer"></div>

<script>
    // State management
    let activeModal = null;
    let promotionToDelete = null;
    let promotionToEdit = null;
    let promotionToView = null;
    let promotions = [];
    let filteredPromotions = [];
    let searchResults = [];
    let searchQuery = '';
    let currentPage = 1;
    const recordsPerPage = 5;
    let promotionDataToSave = null;
    let conditions = [];

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        let storedPromotions = localStorage.getItem('promotions');
        if (!storedPromotions) {
            promotions = [
                {
                    id: "CT001",
                    name: "Khai trương chi nhánh A",
                    startDate: "2025-06-01",
                    endDate: "2025-06-30",
                    type: "Hóa đơn-Giảm giá theo %",
                    discount: "10 %",
                    status: "Kích hoạt",
                    scope: "Chi nhánh A",
                    notes: "Khuyến mại khai trương",
                    conditions: [{ id: 1, type: "Giá trị tối thiểu", value: "500000" }]
                },
                {
                    id: "CT002",
                    name: "Mua 2 tặng 1",
                    startDate: "2025-06-10",
                    endDate: "2025-07-10",
                    type: "Sản phẩm-Giảm giá trực tiếp (VND)",
                    discount: "100000 VND",
                    status: "Kích hoạt",
                    scope: "Toàn bộ chi nhánh",
                    notes: "Áp dụng cho sản phẩm cụ thể",
                    conditions: [{ id: 2, type: "Số lượng sản phẩm tối thiểu", value: "2" }]
                },
                {
                    id: "CT003",
                    name: "Giảm giá mùa hè",
                    startDate: "2025-07-01",
                    endDate: "2025-08-31",
                    type: "Hóa đơn-Giảm giá theo %",
                    discount: "15 %",
                    status: "Chưa kích hoạt",
                    scope: "Chi nhánh B",
                    notes: "Chương trình mùa hè",
                    conditions: [{ id: 3, type: "Giá trị tối thiểu", value: "1000000" }]
                },
                {
                    id: "CT004",
                    name: "Black Friday",
                    startDate: "2025-11-20",
                    endDate: "2025-11-30",
                    type: "Hóa đơn-Giảm giá theo %",
                    discount: "20 %",
                    status: "Chưa kích hoạt",
                    scope: "Toàn bộ chi nhánh",
                    notes: "Sự kiện Black Friday",
                    conditions: []
                },
                {
                    id: "CT005",
                    name: "Tặng quà khách VIP",
                    startDate: "2025-06-15",
                    endDate: "2025-12-31",
                    type: "Sản phẩm-Giảm giá trực tiếp (VND)",
                    discount: "50000 VND",
                    status: "Kích hoạt",
                    scope: "Chi nhánh C",
                    notes: "Dành cho khách VIP",
                    conditions: [{ id: 4, type: "Giá trị tối thiểu", value: "2000000" }]
                }
            ];
            localStorage.setItem('promotions', JSON.stringify(promotions));
        } else {
            promotions = JSON.parse(storedPromotions);
        }
        filteredPromotions = [...promotions];
        renderTable();
        updatePagination();
    });

    // Modal templates
    const modalTemplates = {
        success: `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 animate-fade-in modal-instance">
                <div class="bg-gray-50 rounded-lg shadow-2xl border border-black p-8 max-w-sm w-full text-center animate-slide-up">
                    <div class="w-12 h-12 rounded-full border-4 border-green-700 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-green-700 text-xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-black mb-2">Thêm thành công</h2>
                    <p class="text-base text-black mb-6">Bạn đã thêm thành công chương trình khuyến mại mới.</p>
                    <button onclick="closeModal()" class="w-32 px-4 py-2 bg-gray-200 rounded-md shadow-md hover:bg-gray-300 transition-colors">
                        <span class="text-black font-semibold">Thoát</span>
                    </button>
                </div>
            </div>
        `,
        editSuccess: `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 animate-fade-in modal-instance">
                <div class="bg-gray-50 rounded-lg shadow-2xl border border-black p-8 max-w-sm w-full text-center animate-slide-up">
                    <div class="w-12 h-12 rounded-full border-4 border-green-700 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-green-700 text-xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-black mb-2">Sửa thành công</h2>
                    <p class="text-base text-black mb-6">Thông tin chương trình khuyến mại đã được cập nhật.</p>
                    <button onclick="closeModal()" class="w-32 px-4 py-2 bg-gray-200 rounded-md shadow-md hover:bg-gray-300 transition-colors">
                        <span class="text-black font-semibold">Thoát</span>
                    </button>
                </div>
            </div>
        `,
        deleteConfirm: (name) => `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 animate-fade-in modal-instance">
                <div class="bg-gray-50 rounded-lg shadow-2xl border border-black p-8 max-w-md w-full text-center animate-slide-up">
                    <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-black mb-2">Bạn có chắc chắn muốn xóa không?</h2>
                    <p class="text-base text-black text-left mb-4">Sau khi xóa, "<span class="font-semibold">${name}</span>" sẽ không thể khôi phục lại.</p>
                    <div class="flex justify-center space-x-4">
                        <button onclick="handleConfirmDelete()" class="flex-1 px-4 py-2 bg-black hover:bg-black text-white rounded-md shadow-md transition-colors font-semibold">
                            Có
                        </button>
                        <button onclick="closeDeleteConfirmModal()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-black rounded-md shadow-md transition-colors font-semibold">
                            Không
                        </button>
                    </div>
                </div>
            </div>
        `,
        deleteSuccess: `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 animate-fade-in modal-instance">
                <div class="bg-gray-50 rounded-lg shadow-2xl border border-black p-8 max-w-sm w-full text-center animate-slide-up">
                    <div class="w-12 h-12 rounded-full border-4 border-purple-600 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-green-700 text-xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-black mb-2">Xóa thành công</h2>
                    <p class="text-base text-black mb-6">Chương trình khuyến mại đã được xóa bỏ.</p>
                    <button onclick="closeModal()" class="w-32 px-4 py-2 bg-gray-200 rounded-md shadow-md hover:bg-gray-300 transition-colors">
                        <span class="text-black font-semibold">Thoát</span>
                    </button>
                </div>
            </div>
        `,
        editConfirm: `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 animate-fade-in modal-instance">
                <div class="bg-gray-50 rounded-lg shadow-2xl border border-black p-8 max-w-md w-full text-center animate-slide-up">
                    <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-black mb-2">Bạn có chắc chắn muốn sửa không?</h2>
                    <p class="text-base text-black text-left mb-4">Thông tin của chương trình khuyến mại sẽ được cập nhật vĩnh viễn.</p>
                    <div class="flex justify-center space-x-4">
                        <button onclick="handleConfirmEdit()" class="flex-1 px-4 py-2 bg-black hover:bg-gray-700 text-white rounded-md shadow-md transition-colors font-semibold">
                            Có
                        </button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-black rounded-md shadow-md transition-colors font-semibold">
                            Không
                        </button>
                    </div>
                </div>
            </div>
        `,
        add: (isEdit, data = {}, conditions = []) => `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 animate-fade-in modal-instance">
                <div class="w-full max-w-5xl max-h-[90vh] bg-gray-50 rounded-lg shadow-2xl flex flex-col animate-slide-up overflow-y-auto">
                    <header class="flex items-center justify-between p-5 border-b-4 border-black rounded-t-lg">
                        <h2 class="text-xl font-bold text-black">${isEdit ? 'Sửa chương trình khuyến mại' : 'Thêm chương trình khuyến mại'}</h2>
                        <button onclick="closeModal()" class="w-6 h-6 flex items-center justify-center hover:bg-gray-200 rounded">
                            <i class="fas fa-times text-black"></i>
                        </button>
                    </header>
                    <div class="p-8 space-y-8">
                        <fieldset class="space-y-6">
                            <legend class="text-lg font-semibold text-purple-700">Thông tin chung</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="id" class="block text-base font-medium text-black mb-1">Mã chương trình</label>
                                    <input type="text" id="id" value="${data.id || ''}" placeholder="Nhập mã chương trình" class="w-full h-10 px-4 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600" ${isEdit ? 'readonly' : ''}>
                                    <p id="error-id" class="text-red-600 text-sm mt-1 hidden"></p>
                                </div>
                                <div>
                                    <label for="promoName" class="block text-base font-medium text-black mb-1">Tên chương trình</label>
                                    <input type="text" id="promoName" value="${data.promoName || ''}" placeholder="VD: Khai trương hồng phát" class="w-full h-10 px-4 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600">
                                    <p id="error-promoName" class="text-red-600 text-sm mt-1 hidden"></p>
                                </div>
                                <div>
                                    <label class="block text-base font-medium text-black mb-1">Trạng thái</label>
                                    <div class="flex items-center space-x-6 h-10">
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <input type="radio" name="status" value="active" ${data.status === 'active' || !isEdit ? 'checked' : ''} class="peer-sr-only">
                                            <div class="radio-dot"><div class="radio-dot-inner"></div></div>
                                            <span class="text-gray-800">Kích hoạt</span>
                                        </label>
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <input type="radio" name="status" value="inactive" ${data.status === 'inactive' && isEdit ? 'checked' : ''} class="peer-sr-only">
                                            <div class="radio-dot"><div class="radio-dot-inner"></div></div>
                                            <span class="text-gray-800">Chưa kích hoạt</span>
                                        </label>
                                    </div>
                                    <p id="error-status" class="text-red-600 text-sm mt-1 hidden"></p>
                                </div>
                                <div>
                                    <label for="notes" class="block text-base font-medium text-black mb-1">Ghi chú</label>
                                    <input type="text" id="notes" value="${data.notes || ''}" placeholder="Thông tin thêm về chương trình" class="w-full h-10 px-4 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600">
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="space-y-6">
                            <legend class="text-lg font-semibold text-purple-700">Hình thức & Mức giảm</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div>
                                    <label for="promoBy" class="block text-base font-medium text-black mb-1">Khuyến mại theo</label>
                                    <select id="promoBy" class="w-full h-10 px-3 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600">
                                        <option value="Hóa đơn" ${data.promoBy === 'Hóa đơn' ? 'selected' : ''}>Hóa đơn</option>
                                        <option value="Sản phẩm" ${data.promoBy === 'Sản phẩm' ? 'selected' : ''}>Sản phẩm</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="promoType" class="block text-base font-medium text-black mb-1">Hình thức</label>
                                    <select id="promoType" class="w-full h-10 px-3 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600" onchange="updateDiscountUnit()">
                                        <option value="Giảm giá theo %" ${data.promoType === 'Giảm giá theo %' ? 'selected' : ''}>Giảm giá theo %</option>
                                        <option value="Giảm giá trực tiếp (VND)" ${data.promoType === 'Giảm giá trực tiếp (VND)' ? 'selected' : ''}>Giảm giá trực tiếp (VND)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="discountValue" class="block text-base font-medium text-black mb-1">Mức giảm</label>
                                    <div class="relative">
                                        <input type="number" id="discountValue" value="${data.discountValue || ''}" placeholder="VD: 10" class="w-full h-10 pl-4 pr-10 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600">
                                        <span id="discountUnit" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">${data.promoType === 'Giảm giá trực tiếp (VND)' ? 'VND' : '%'}</span>
                                    </div>
                                    <p id="error-discountValue" class="text-red-600 text-sm mt-1 hidden"></p>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="space-y-6">
                            <legend class="text-lg font-semibold text-purple-700">Thời gian & Phạm vi</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                                <div class="space-y-6">
                                    <div>
                                        <label for="startDate" class="block text-base font-medium text-black mb-1">Ngày bắt đầu</label>
                                        <input type="date" id="startDate" value="${data.startDate || '2025-06-15'}" class="w-full h-10 px-4 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600">
                                    </div>
                                    <div>
                                        <label for="endDate" class="block text-base font-medium text-black mb-1">Ngày kết thúc</label>
                                        <input type="date" id="endDate" value="${data.endDate || '2025-07-15'}" class="w-full h-10 px-4 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600">
                                    </div>
                                    <p id="error-date" class="text-red-600 text-sm mt-1 hidden"></p>
                                </div>
                                <div class="space-y-4">
                                    <label class="block text-base font-medium text-black">Phạm vi áp dụng</label>
                                    <div class="space-y-4">
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <input type="radio" name="scope" value="all" ${data.scope === 'all' || !isEdit ? 'checked' : ''} class="peer-sr-only" onchange="toggleBranchSelect()">
                                            <div class="radio-dot"><div class="radio-dot-inner"></div></div>
                                            <span class="text-black">Toàn bộ chi nhánh</span>
                                        </label>
                                        <div class="flex items-center">
                                            <label class="flex items-center space-x-3 cursor-pointer">
                                                <input type="radio" name="scope" value="specific" ${data.scope === 'specific' && isEdit ? 'checked' : ''} class="peer-sr-only" onchange="toggleBranchSelect()">
                                                <div class="radio-dot"><div class="radio-dot-inner"></div></div>
                                                <span class="text-black">Chi nhánh cụ thể</span>
                                            </label>
                                            <select id="branch" class="ml-5 flex-grow h-10 px-3 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600 transition-colors ${data.scope !== 'specific' ? 'bg-gray-200 cursor-not-allowed' : ''}" ${data.scope !== 'specific' ? 'disabled' : ''}>
                                                <option value="Chi nhánh A" ${data.branch === 'Chi nhánh A' ? 'selected' : ''}>Chi nhánh A</option>
                                                <option value="Chi nhánh B" ${data.branch === 'Chi nhánh B' ? 'selected' : ''}>Chi nhánh B</option>
                                                <option value="Chi nhánh C" ${data.branch === 'Chi nhánh C' ? 'selected' : ''}>Chi nhánh C</option>
                                            </select>
                                        </div>
                                    </div>
                                    <p id="error-scope" class="text-red-600 text-sm mt-1 hidden"></p>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend class="text-lg font-semibold text-purple-700">Điều kiện áp dụng</legend>
                            <div id="conditionsContainer" class="mt-4 space-y-4">
                                ${conditions.map((c, i) => `
                                    <div class="flex items-center space-x-4 p-4 bg-purple-50 rounded-lg animate-fade-in" data-id="${c.id}">
                                        <span class="font-bold text-gray-600">#${i + 1}</span>
                                        <select class="w-1/3 h-10 px-3 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600 transition" onchange="updateCondition(${c.id}, 'type', this.value)">
                                            <option value="Giá trị tối thiểu" ${c.type === 'Giá trị tối thiểu' ? 'selected' : ''}>Giá trị tối thiểu</option>
                                            <option value="Số lượng sản phẩm tối thiểu" ${c.type === 'Số lượng sản phẩm tối thiểu' ? 'selected' : ''}>Số lượng sản phẩm tối thiểu</option>
                                        </select>
                                        <input type="text" placeholder="Nhập giá trị (VD: 500000)" value="${c.value}" class="flex-grow h-10 px-4 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600 transition" oninput="updateCondition(${c.id}, 'value', this.value)">
                                        <button onclick="removeCondition(${c.id})" class="w-10 h-10 flex-shrink-0 text-red-500 hover:bg-red-100 rounded-full flex items-center justify-center transition-colors" title="Xóa điều kiện">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            <button type="button" onclick="addCondition()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-black rounded-md shadow-md transition-colors font-semibold">
                                <i class="fas fa-plus"></i><span>Thêm điều kiện</span>
                            </button>
                            <p class="text-xs text-gray-500 mt-2">VD: Tổng hóa đơn tối thiểu 500,000 VND.</p>
                        </fieldset>
                    </div>
                    <footer class="flex justify-end items-center p-5 space-x-4   rounded-b-lg mt-auto">
                        <button onclick="handleSave()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md shadow-md transition-colors inline-flex items-center gap-2">
                            <i class="fas fa-save"></i><span>Lưu</span>
                        </button>
                        <button onclick="closeModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-black rounded-md shadow-md transition-colors font-semibold">Thoát</button>

                    </footer>
                </div>
            </div>
        `,
        filter: `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 animate-fade-in modal-instance">
                <div class="bg-gray-50 rounded-lg shadow-2xl border border-black p-6 w-96 animate-slide-up">
                    <h2 class="text-xl font-bold text-black mb-6 text-center">Lọc chương trình khuyến mãi</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="filter-branch" class="block text-base font-medium text-black mb-1">Chi nhánh:</label>
                            <select id="filter-branch" class="w-full h-10 px-3 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600">
                                <option value="Tất cả">Tất cả</option>
                                <option value="Chi nhánh A">Chi nhánh A</option>
                                <option value="Chi nhánh B">Chi nhánh B</option>
                                <option value="Chi nhánh C">Chi nhánh C</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base font-medium text-black mb-1">Trạng thái:</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="filter-status" value="Tất cả" checked class="peer-sr-only">
                                    <div class="radio-dot"><div class="radio-dot-inner"></div></div>
                                    <span class="text-black">Tất cả</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="filter-status" value="Kích hoạt" class="peer-sr-only">
                                    <div class="radio-dot"><div class="radio-dot-inner"></div></div>
                                    <span class="text-black">Kích hoạt</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="filter-status" value="Chưa kích hoạt" class="peer-sr-only">
                                    <div class="radio-dot"><div class="radio-dot-inner"></div></div>
                                    <span class="text-black">Chưa kích hoạt</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-base font-medium text-black mb-1">Hiệu lực:</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="filter-validity" value="Tất cả" checked class="peer-sr-only">
                                    <div class="radio-dot"><div class="radio-dot-inner"></div></div>
                                    <span class="text-black">Tất cả</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="filter-validity" value="Còn hiệu lực" class="peer-sr-only">
                                    <div class="radio-dot"><div class="radio-dot-inner"></div></div>
                                    <span class="text-black">Còn hiệu lực</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="filter-validity" value="Hết hiệu lực" class="peer-sr-only">
                                    <div class="radio-dot"><div class="radio-dot-inner"></div></div>
                                    <span class="text-black">Hết hiệu lực</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 mt-8">
                        <button onclick="closeModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-black rounded-md shadow-md transition-colors font-semibold">Thoát</button>
                        <button onclick="handleFilter()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md shadow-md transition-colors font-semibold">Lọc</button>
                    </div>
                </div>
            </div>
        `,
        details: (promotion) => {
            const currentDate = new Date();
            const startDate = new Date(promotion.startDate);
            const endDate = new Date(promotion.endDate);
            const formattedStartDate = startDate.toLocaleDateString('vi-VN');
            const formattedEndDate = endDate.toLocaleDateString('vi-VN');
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 animate-fade-in modal-instance">
                    <div class="bg-gray-50 rounded-lg shadow-2xl border border-black p-6 w-full max-w-2xl animate-slide-up">
                        <div class="flex justify-between items-center border-b-4 border-black pb-4 mb-4">
                            <h2 class="text-xl font-bold text-black">Thông tin chương trình khuyến mại</h2>
                            <button onclick="closeModal()" class="w-6 h-6 flex items-center justify-center hover:bg-gray-200 rounded">
                                <i class="fas fa-times text-black"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="font-medium">Mã CT:</span> <span>${promotion.id}</span></div>
                                <div><span class="font-medium">Tên CT:</span> <span>${promotion.name}</span></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="font-medium">Hình thức:</span> <span>${promotion.type}</span></div>
                                <div><span class="font-medium">Trạng thái:</span> <span>${promotion.status}</span></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="font-medium">Hiệu lực:</span> <span>${formattedStartDate} đến ${formattedEndDate}</span></div>
                                <div><span class="font-medium">Ghi chú:</span> <span>${promotion.notes || 'Không có'}</span></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="font-medium">Chi nhánh áp dụng:</span> <span>${promotion.scope}</span></div>
                                <div><span class="font-medium">Điều kiện áp dụng:</span> <span>${promotion.conditions.length > 0 ? promotion.conditions.map(c => `${c.type}: ${c.value}`).join(', ') : 'Không có'}</span></div>
                            </div>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button onclick="closeModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-black rounded-md shadow-md transition-colors font-semibold">Thoát</button>
                        </div>
                    </div>
                </div>
            `;
        },
        search: (results) => `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 animate-fade-in modal-instance">
                <div class="bg-gray-50 rounded-lg shadow-2xl border border-black p-6 w-full max-w-3xl animate-slide-up">
                    <div class="flex justify-between items-center border-b-4 border-black pb-4 mb-4">
                        <h2 class="text-xl font-bold text-black">Kết quả tìm kiếm</h2>
                        <button onclick="closeModal()" class="w-6 h-6 flex items-center justify-center hover:bg-gray-200 rounded">
                            <i class="fas fa-times text-black"></i>
                        </button>
                    </div>
                    <p class="text-black mb-4">Nhấn vào để xem thông tin chi tiết</p>
                    <div class="overflow-y-auto max-h-[60vh]">
                        ${results.length > 0 ? `
                            <table class="w-full table-fixed">
                                <thead>
                                    <tr class="bg-purple-200 text-left">
                                        <th class="px-4 py-2 font-semibold text-gray-800">Mã CT</th>
                                        <th class="px-4 py-2 font-semibold text-gray-800">Tên CT</th>
                                        <th class="px-4 py-2 font-semibold text-gray-800">Ngày bắt đầu</th>
                                        <th class="px-4 py-2 font-semibold text-gray-800">Ngày kết thúc</th>
                                        <th class="px-4 py-2 font-semibold text-gray-800">Hình thức</th>
                                        <th class="px-4 py-2 font-semibold text-gray-800">Mức giảm giá</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.map(p => `
                                        <tr class="hover:bg-gray-100 cursor-pointer" onclick='openModal("details", ${JSON.stringify(p)})'>
                                            <td class="px-4 py-2 text-gray-700">${p.id}</td>
                                            <td class="px-4 py-2 text-gray-700">${p.name}</td>
                                            <td class="px-4 py-2 text-gray-700">${new Date(p.startDate).toLocaleDateString('vi-VN')}</td>
                                            <td class="px-4 py-2 text-gray-700">${new Date(p.endDate).toLocaleDateString('vi-VN')}</td>
                                            <td class="px-4 py-2 text-gray-700">${p.type}</td>
                                            <td class="px-4 py-2 text-gray-700">${p.discount}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <p class="text-center text-gray-700">Không có kết quả nào.</p>
                        `}
                    </div>
                    <div class="flex justify-end mt-6">
                        <button onclick="closeModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-black rounded-md shadow-md transition-colors font-semibold">Thoát</button>
                    </div>
                </div>
            </div>
        `
    };

    // --- MODIFIED MODAL MANAGEMENT ---

    function clearAllModalsAndState() {
        document.getElementById('modalContainer').innerHTML = '';
        activeModal = null;
        promotionToEdit = null;
        promotionToDelete = null;
        promotionDataToSave = null;
        promotionToView = null;
        searchResults = [];
        searchQuery = '';
        conditions = [];
    }

    function openModal(type, data = null, overlay = false) {
        if (!overlay) {
            clearAllModalsAndState();
        }

        activeModal = type;
        const modalContainer = document.getElementById('modalContainer');
        let modalHtml = '';

        if (type === 'add') {
            promotionToEdit = null;
            modalHtml = modalTemplates.add(false, {}, []);
        } else if (type === 'edit') {
            promotionToEdit = data;
            let formData = {
                id: data.id,
                promoName: data.name,
                status: data.status === 'Kích hoạt' ? 'active' : 'inactive',
                notes: data.notes || '',
                promoBy: data.type.split('-')[0].trim(),
                promoType: data.type.split('-')[1].trim(),
                discountValue: data.discount.match(/(\d+)/)[0],
                startDate: data.startDate,
                endDate: data.endDate,
                scope: data.scope === 'Toàn bộ chi nhánh' ? 'all' : 'specific',
                branch: data.scope !== 'Toàn bộ chi nhánh' ? data.scope : 'Chi nhánh A'
            };
            conditions = JSON.parse(JSON.stringify(data.conditions || [])); // Deep copy
            modalHtml = modalTemplates.add(true, formData, conditions);
        } else if (type === 'deleteConfirm') {
            promotionToDelete = data;
            modalHtml = modalTemplates.deleteConfirm(data.name);
        } else if (type === 'details') {
            promotionToView = data;
            modalHtml = modalTemplates.details(data);
        } else if (type === 'search') {
            modalHtml = modalTemplates.search(searchResults);
        } else if (modalTemplates[type]) {
            modalHtml = modalTemplates[type];
        }

        modalContainer.insertAdjacentHTML('beforeend', modalHtml);
    }

    function closeModal() {
        const modalContainer = document.getElementById('modalContainer');
        const lastModal = modalContainer.querySelector('.modal-instance:last-child');

        if (lastModal) {
            lastModal.remove();
        }

        if (modalContainer.children.length === 0) {
            clearAllModalsAndState();
        }
    }

    function closeDeleteConfirmModal() {
        closeModal();
    }

    // --- END OF MODIFIED MODAL MANAGEMENT ---

    // Table rendering
    function renderTable() {
        const tbody = document.getElementById('promotionsTableBody');
        tbody.innerHTML = '';
        const start = (currentPage - 1) * recordsPerPage;
        const end = start + recordsPerPage;
        const paginatedPromotions = filteredPromotions.slice(start, end);

        if (paginatedPromotions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-700">Không có dữ liệu</td></tr>';
            return;
        }

        paginatedPromotions.forEach((p, index) => {
            const row = document.createElement('tr');
            row.className = `h-16 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition-colors`;
            row.innerHTML = `
                <td class="px-4 py-2 text-sm text-gray-700">${p.id}</td>
                <td class="px-4 py-2 text-sm text-gray-700 font-medium">${p.name}</td>
                <td class="px-4 py-2 text-sm text-gray-700">${new Date(p.startDate).toLocaleDateString('vi-VN')}</td>
                <td class="px-4 py-2 text-sm text-gray-700">${new Date(p.endDate).toLocaleDateString('vi-VN')}</td>
                <td class="px-4 py-2 text-sm text-gray-700">${p.type}</td>
                <td class="px-4 py-2 text-sm text-gray-700">${p.discount}</td>
                <td class="px-4 py-2 text-sm text-gray-700">
                    <span class="px-2 py-1 rounded-full text-xs font-medium">${p.status}</span>
                </td>
                <td class="px-4 py-2">
                    <div class="flex space-x-2">
                        <button onclick='openModal("details", ${JSON.stringify(p)})' class="text-black hover:text-gray-800 p-1 hover:bg-gray-50 rounded transition-colors" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick='openModal("edit", ${JSON.stringify(p)})' class="text-black hover:text-gray-800 p-1 hover:bg-gray-50 rounded transition-colors" title="Chỉnh sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick='openModal("deleteConfirm", ${JSON.stringify(p)})' class="text-black hover:text-gray-800 p-1 hover:bg-gray-50 rounded transition-colors" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // Pagination rendering
    function updatePagination() {
        const totalPages = Math.ceil(filteredPromotions.length / recordsPerPage);
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage >= totalPages;

        const pageButtons = document.getElementById('pageButtons');
        pageButtons.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            const button = document.createElement('button');
            button.className = `px-3 py-1 rounded transition-colors ${i === currentPage ? 'bg-purple-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`;
            button.textContent = i;
            button.onclick = () => changePage(i);
            pageButtons.appendChild(button);
        }
    }

    function changePage(page) {
        currentPage = page;
        renderTable();
        updatePagination();
    }

    // Form handling
    function updateDiscountUnit() {
        const promoType = document.getElementById('promoType').value;
        document.getElementById('discountUnit').textContent = promoType === 'Giảm giá theo %' ? '%' : 'VND';
    }

    function toggleBranchSelect() {
        const scope = document.querySelector('input[name="scope"]:checked').value;
        const branchSelect = document.getElementById('branch');
        if (scope === 'all') {
            branchSelect.disabled = true;
            branchSelect.classList.add('bg-gray-200', 'cursor-not-allowed');
        } else {
            branchSelect.disabled = false;
            branchSelect.classList.remove('bg-gray-200', 'cursor-not-allowed');
        }
    }

    function addCondition() {
        const newCondition = { id: Date.now(), type: 'Giá trị tối thiểu', value: '' };
        conditions.push(newCondition);
        renderConditions();
    }

    function removeCondition(id) {
        conditions = conditions.filter(c => c.id !== id);
        renderConditions();
    }

    function updateCondition(id, field, value) {
        conditions = conditions.map(c => c.id === id ? { ...c, [field]: value } : c);
    }

    function renderConditions() {
        const container = document.getElementById('conditionsContainer');
        container.innerHTML = conditions.map((c, i) => `
            <div class="flex items-center space-x-4 p-4 bg-purple-50 rounded-lg animate-fade-in" data-id="${c.id}">
                <span class="font-bold text-gray-600">#${i + 1}</span>
                <select class="w-1/3 h-10 px-3 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600 transition" onchange="updateCondition(${c.id}, 'type', this.value)">
                    <option value="Giá trị tối thiểu" ${c.type === 'Giá trị tối thiểu' ? 'selected' : ''}>Giá trị tối thiểu</option>
                    <option value="Số lượng sản phẩm tối thiểu" ${c.type === 'Số lượng sản phẩm tối thiểu' ? 'selected' : ''}>Số lượng sản phẩm tối thiểu</option>
                </select>
                <input type="text" placeholder="Nhập giá trị (VD: 500000)" value="${c.value}" class="flex-grow h-10 px-4 bg-gray-50 rounded-md shadow-md border border-neutral-400 focus:ring-2 focus:ring-purple-600 transition" oninput="updateCondition(${c.id}, 'value', this.value)">
                <button onclick="removeCondition(${c.id})" class="w-10 h-10 flex-shrink-0 text-red-500 hover:bg-red-100 rounded-full flex items-center justify-center transition-colors" title="Xóa điều kiện">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        `).join('');
    }

    function handleSave() {
        const formData = {
            id: document.getElementById('id').value.trim(),
            promoName: document.getElementById('promoName').value.trim(),
            status: document.querySelector('input[name="status"]:checked')?.value,
            notes: document.getElementById('notes').value.trim(),
            promoBy: document.getElementById('promoBy').value,
            promoType: document.getElementById('promoType').value,
            discountValue: document.getElementById('discountValue').value.trim(),
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            scope: document.querySelector('input[name="scope"]:checked')?.value,
            branch: document.getElementById('branch').value
        };

        // Validation
        const errors = {};
        if (!formData.id) {
            errors.id = 'Mã chương trình không được để trống';
        } else if (!promotionToEdit && promotions.some(p => p.id === formData.id)) {
            errors.id = 'Mã chương trình này đã tồn tại';
        }
        if (!formData.promoName) {
            errors.promoName = 'Tên chương trình không được để trống';
        }
        if (!formData.status) {
            errors.status = 'Vui lòng chọn trạng thái';
        }
        if (!formData.discountValue || isNaN(formData.discountValue) || Number(formData.discountValue) <= 0) {
            errors.discountValue = 'Mức giảm không được để trống và phải là số lớn hơn 0';
        }
        if (!formData.startDate || !formData.endDate) {
            errors.date = 'Vui lòng chọn ngày bắt đầu và kết thúc';
        } else if (new Date(formData.startDate) > new Date(formData.endDate)) {
            errors.date = 'Ngày kết thúc phải lớn hơn hoặc bằng ngày bắt đầu';
        }
        if (!formData.scope) {
            errors.scope = 'Vui lòng chọn phạm vi áp dụng';
        }

        // Display errors
        ['id', 'promoName', 'status', 'discountValue', 'date', 'scope'].forEach(field => {
            const errorEl = document.getElementById(`error-${field}`);
            if (errorEl) {
                if (errors[field]) {
                    errorEl.textContent = errors[field];
                    errorEl.classList.remove('hidden');
                } else {
                    errorEl.classList.add('hidden');
                }
            }
        });

        if (Object.keys(errors).length > 0) return;

        const promotionData = {
            id: formData.id,
            name: formData.promoName,
            startDate: formData.startDate,
            endDate: formData.endDate,
            type: `${formData.promoBy}-${formData.promoType}`,
            discount: `${formData.discountValue} ${formData.promoType === 'Giảm giá theo %' ? '%' : 'VND'}`,
            status: formData.status === 'active' ? 'Kích hoạt' : 'Chưa kích hoạt',
            scope: formData.scope === 'all' ? 'Toàn bộ chi nhánh' : formData.branch,
            notes: formData.notes || 'Không có',
            conditions: conditions.filter(c => c.value.trim() !== '')
        };

        if (promotionToEdit) {
            promotionDataToSave = promotionData;
            // --- CHANGE HERE: Open confirm modal as an overlay ---
            openModal('editConfirm', null, true);
        } else {
            handleAddPromotion(promotionData);
        }
    }

    // CRUD operations
    function handleAddPromotion(newPromotion) {
        try {
            promotions.push(newPromotion);
            localStorage.setItem('promotions', JSON.stringify(promotions));
            filteredPromotions = [...promotions];
            clearAllModalsAndState();
            openModal('success');
            renderTable();
            updatePagination();
        } catch (error) {
            console.error('Lỗi khi thêm mới:', error);
        }
    }

    function handleUpdatePromotion(updatedPromotion) {
        try {
            promotions = promotions.map(p => p.id === updatedPromotion.id ? updatedPromotion : p);
            localStorage.setItem('promotions', JSON.stringify(promotions));
            filteredPromotions = [...promotions];
            clearAllModalsAndState();
            openModal('editSuccess');
            renderTable();
            updatePagination();
        } catch (error) {
            console.error('Lỗi khi cập nhật:', error);
        }
    }

    function handleDeletePromotion(id) {
        try {
            promotions = promotions.filter(p => p.id !== id);
            localStorage.setItem('promotions', JSON.stringify(promotions));
            filteredPromotions = [...promotions];
            const totalPages = Math.ceil(filteredPromotions.length / recordsPerPage);
            if (currentPage > totalPages) {
                currentPage = 1;
            }
            clearAllModalsAndState();
            openModal('deleteSuccess');
            renderTable();
            updatePagination();
        } catch (error) {
            console.error('Lỗi khi xóa:', error);
        }
    }

    function handleConfirmDelete() {
        if (promotionToDelete && promotionToDelete.id) {
            handleDeletePromotion(promotionToDelete.id);
        }
    }

    function handleConfirmEdit() {
        if (promotionDataToSave) {
            handleUpdatePromotion(promotionDataToSave);
        }
    }

    // Search and filter
    function handleSearch() {
        searchQuery = document.getElementById('searchInput').value.trim();
        if (!searchQuery || searchQuery.length < 2) {
            searchResults = [];
            openModal('search');
            return;
        }
        searchResults = promotions.filter(p =>
            p.id.toLowerCase().includes(searchQuery.toLowerCase()) ||
            p.name.toLowerCase().includes(searchQuery.toLowerCase())
        );
        openModal('search');
    }

    function handleFilter() {
        const filterData = {
            branch: document.getElementById('filter-branch').value,
            status: document.querySelector('input[name="filter-status"]:checked').value,
            validity: document.querySelector('input[name="filter-validity"]:checked').value
        };
        let filtered = [...promotions];
        if (filterData.branch !== 'Tất cả') {
            filtered = filtered.filter(p => p.scope === filterData.branch || p.scope === 'Toàn bộ chi nhánh');
        }
        if (filterData.status !== 'Tất cả') {
            filtered = filtered.filter(p => p.status === filterData.status);
        }
        if (filterData.validity !== 'Tất cả') {
            const now = new Date();
            filtered = filtered.filter(p => {
                const endDate = new Date(p.endDate);
                return filterData.validity === 'Còn hiệu lực' ? endDate > now : endDate <= now;
            });
        }
        filteredPromotions = filtered;
        currentPage = 1;
        renderTable();
        updatePagination();
        closeModal();
    }

    document.getElementById('prevPage').onclick = () => changePage(currentPage - 1);
    document.getElementById('nextPage').onclick = () => changePage(currentPage + 1);

    window.addEventListener('DOMContentLoaded', () => {
        // This is a check to ensure the function exists when called from inline HTML
        if (typeof updateDiscountUnit !== 'function') {
            window.updateDiscountUnit = updateDiscountUnit;
        }
    });
</script>
</body>
</html>