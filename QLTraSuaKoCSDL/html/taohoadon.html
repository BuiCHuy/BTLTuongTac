<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FiveH Tạo Hóa Đơn</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .scrollable { max-height: 400px; overflow-y: auto; }
  </style>
</head>
<body class="min-h-screen bg-gray-100">
<!-- Header -->
<header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between">
  <h1 class="text-2xl font-bold text-black">FiveH</h1>
  <div class="flex items-center space-x-6">
    <div class="flex items-center space-x-2 cursor-pointer hover:text-indigo-600 transition-colors">
      <i class="fas fa-cog text-gray-600 text-lg"></i>
      <span class="text-gray-700">Cài đặt</span>
    </div>
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-gray-300 rounded-full"></div>
      <div class="flex flex-col">
        <span class="text-gray-700 font-medium">Quản lý</span>
        <span class="text-gray-500 text-sm cursor-pointer hover:text-indigo-600">Đăng xuất</span>
      </div>
    </div>
  </div>
</header>

<!-- Navigation -->
<nav class="bg-gradient-to-r from-purple-600 to-rose-500 py-4 px-6 shadow-md">
  <div class="max-w-7xl mx-auto flex justify-between items-center text-white">
    <a href="Trangchu.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors text-pink-100">
      <i class="fas fa-home text-lg"></i>
      <span class="text-lg font-semibold">Trang chủ</span>
    </a>
    <a href="QLbanhang.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors">
      <i class="fas fa-shopping-cart text-lg"></i>
      <span class="text-lg font-semibold">Bán hàng</span>
    </a>
    <a href="Staff.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors">
      <i class="fas fa-users text-lg"></i>
      <span class="text-lg font-semibold">Nhân viên</span>
    </a>
    <a href="PageQLMH.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors">
      <i class="fas fa-box text-lg"></i>
      <span class="text-lg font-semibold">Mặt hàng</span>
    </a>
    <a href="PageQLCTKM.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors">
      <i class="fas fa-tags text-lg"></i>
      <span class="text-lg font-semibold">CT Khuyến mại</span>
    </a>
    <a href="Revenue.html" class="flex items-center space-x-2 cursor-pointer hover:text-gray-200 transition-colors">
      <i class="fas fa-chart-line text-lg"></i>
      <span class="text-lg font-semibold">Doanh thu</span>
    </a>
  </div>
</nav>

<!-- Main Content -->
<div class="p-6">
  <h1 class="text-3xl font-bold text-black mb-6">Tạo hóa đơn</h1>
  <div class="flex gap-1">
    <!-- Products Section -->
    <div class="w-1/2 border border-gray-300 rounded-l-lg p-4 bg-white">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-black">Mặt hàng</h2>
        <div class="relative w-64">
          <input type="text" id="searchInput" placeholder="Tìm hàng" class="w-full p-2 border border-gray-300 rounded-md pr-10">
          <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
      </div>
      <div id="productsContainer" class="scrollable"></div>
    </div>

    <!-- Invoice Section -->
    <div class="w-1/2 border border-gray-300 border-l-0 rounded-r-lg p-4 bg-white relative">
      <h2 class="text-xl font-bold text-black mb-4">Hóa đơn</h2>
      <div class="bg-white border border-gray-200 rounded-lg p-4">
        <table class="w-full" id="invoiceTable">
          <thead>
          <tr class="border-b border-gray-200">
            <th class="text-left py-2 text-sm font-medium">Mặt hàng</th>
            <th class="text-left py-2 text-sm font-medium">Số lượng</th>
            <th class="text-left py-2 text-sm font-medium">Đơn giá</th>
            <th class="text-left py-2 text-sm font-medium">Thành tiền</th>
            <th class="w-8"></th>
          </tr>
          </thead>
          <tbody id="invoiceItems"></tbody>
        </table>
        <div class="mt-4 space-y-1 text-right">
          <p class="text-sm" id="totalAmount">Tổng tiền (số): 0 đ</p>
          <p class="text-sm" id="totalInWords">Tổng tiền (chữ): Không đồng</p>
        </div>
      </div>
      <div class="absolute bottom-0 right-4 flex gap-10 text-white p-2">
        <div class="flex justify-end gap-2 mt-4">
          <button id="cancelOrderBtn" class="bg-red-600 w-[150px] h-8 text-sm rounded flex items-center justify-center gap-5">
            <i class="fas fa-times"></i> Hủy đơn
          </button>
          <button id="paymentBtn" class="bg-white border border-black text-black w-[150px] h-8 text-sm rounded flex items-center justify-center gap-5">
            <i class="fas fa-check"></i> Thanh toán
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div id="addProductModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4">
    <h3 class="text-xl font-bold text-center mb-4">Điền số lượng</h3>
    <div class="flex justify-between gap-2 mt-4">
      <div class="flex justify-center mb-6 pl-8">
        <div class="text-center">
          <img id="modalProductImage" src="" alt="" class="w-32 h-32 object-cover rounded mb-2 mx-auto">
          <p id="modalProductName" class="text-sm font-medium"></p>
          <p id="modalProductPrice" class="text-sm text-gray-600"></p>
        </div>
      </div>
      <div class="flex items-center justify-center mb-6 pr-8">
        <input type="number" id="modalQuantity" value="1" class="w-20 h-10 text-center border border-gray-300 rounded px-1" min="1">
      </div>
    </div>
    <div class="flex gap-3">
      <button id="cancelModalBtn" class="bg-red-600 w-[150px] h-8 text-sm rounded flex items-center justify-center gap-5 text-white">
        <i class="fas fa-times"></i> Hủy
      </button>
      <button id="confirmModalBtn" class="bg-white border border-black text-black w-[150px] h-8 text-sm rounded flex items-center justify-center gap-5">
        <i class="fas fa-check"></i> Xác nhận
      </button>
    </div>
  </div>
</div>

<!-- Confirm Remove Modal -->
<div id="confirmRemoveModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4 text-center">
    <i class="fas fa-exclamation-circle text-white bg-black border-white border-2 rounded-full p-1 text-xl mb-4"></i>
    <h3 id="confirmRemoveText" class="text-lg font-bold mb-4"></h3>
    <div class="flex justify-center gap-4">
      <button id="confirmRemoveBtn" class="bg-black w-[100px] h-8 text-sm rounded flex items-center justify-center gap-2 text-white">
        <i class="fas fa-check"></i> Có
      </button>
      <button id="cancelRemoveBtn" class="bg-white border border-black text-black w-[100px] h-8 text-sm rounded flex items-center justify-center gap-2">
        <i class="fas fa-times"></i> Không
      </button>
    </div>
  </div>
</div>

<!-- Cancel Order Modal -->
<div id="cancelOrderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4 text-center">
    <i class="fas fa-exclamation-circle text-white bg-black border-white border-2 rounded-full p-1 text-xl mb-4"></i>
    <h3 class="text-lg font-bold mb-4">Bạn có chắc chắn muốn hủy đơn?</h3>
    <div class="flex justify-center gap-4">
      <button id="confirmCancelOrderBtn" class="bg-black w-[100px] h-8 text-sm rounded flex items-center justify-center gap-2 text-white">
        <i class="fas fa-check"></i> Có
      </button>
      <button id="cancelCancelOrderBtn" class="bg-white border border-black text-black w-[100px] h-8 text-sm rounded flex items-center justify-center gap-2">
        <i class="fas fa-times"></i> Không
      </button>
    </div>
  </div>
</div>

<script>
  let searchTerm = "";
  let orderItems = JSON.parse(localStorage.getItem('currentOrder')) || [
    { product: { id: "4", name: "Trà sữa matcha", price: 20000, image: "", category: "Đồ uống" }, quantity: 2 },
    { product: { id: "1", name: "Trà sữa trân châu", price: 20000, image: "", category: "Đồ uống" }, quantity: 1 }
  ];
  let products = JSON.parse(localStorage.getItem('products')) || [
    { id: "1", name: "Trà sữa trân châu", price: 20000, image: "", category: "Đồ uống" },
    { id: "2", name: "Trà sữa trân châu 2", price: 25000, image: "", category: "Đồ uống" },
    { id: "3", name: "Khoai tây chiên", price: 25000, image: "", category: "Đồ ăn vặt" },
    { id: "4", name: "Trà sữa matcha", price: 20000, image: "", category: "Đồ uống" }
  ];
  let selectedProduct = null;
  let selectedItemToRemove = null;

  // Lưu sản phẩm vào Local Storage khi khởi tạo
  if (!localStorage.getItem('products')) {
    localStorage.setItem('products', JSON.stringify(products));
  }

  // Hàm chuyển số thành chữ
  function numberToWords(num) {
    const units = ["", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín"];
    const tens = ["", "mười", "hai mươi", "ba mươi", "bốn mươi", "năm mươi", "sáu mươi", "bảy mươi", "tám mươi", "chín mươi"];
    const thousands = ["", "nghìn", "triệu", "tỷ"];
    if (num === 0) return "không đồng";
    let result = "";
    let thousandIndex = 0;
    while (num > 0) {
      let part = num % 1000;
      if (part > 0) {
        let partStr = "";
        let hundred = Math.floor(part / 100);
        let ten = Math.floor((part % 100) / 10);
        let unit = part % 10;
        if (hundred > 0) partStr += units[hundred] + " trăm";
        if (ten > 1) {
          partStr += (partStr ? " " : "") + tens[ten];
          if (unit > 0) partStr += " " + units[unit];
        } else if (ten === 1) {
          partStr += (partStr ? " " : "") + "mười";
          if (unit > 0) partStr += " " + units[unit];
        } else if (unit > 0) {
          partStr += (partStr ? " " : "") + units[unit];
        }
        result = partStr + (thousands[thousandIndex] ? " " + thousands[thousandIndex] : "") + (result ? " " : "") + result;
      }
      num = Math.floor(num / 1000);
      thousandIndex++;
    }
    return result.trim() + " đồng";
  }

  // Tải dữ liệu và render
  function init() {
    renderProducts();
    renderInvoice();
  }

  // Render danh sách sản phẩm
  function renderProducts() {
    const filteredProducts = products.filter(product => product.name.toLowerCase().includes(searchTerm.toLowerCase()));
    const groupedProducts = filteredProducts.reduce((acc, product) => {
      if (!acc[product.category]) acc[product.category] = [];
      acc[product.category].push(product);
      return acc;
    }, {});
    const container = document.getElementById('productsContainer');
    container.innerHTML = '';
    Object.entries(groupedProducts).forEach(([category, categoryProducts]) => {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'mb-6';
      categoryDiv.innerHTML = `
                    <div class="border-t border-gray-300 pt-2 mb-4">
                        <h3 class="text-lg font-bold text-black">${category}</h3>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        ${categoryProducts.map(product => `
                            <div class="bg-white border border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition-shadow" onclick="openProductModal('${product.id}')">
                                <img src="${product.image || '/placeholder.svg'}" alt="${product.name}" class="w-full h-32 object-cover rounded mb-2">
                                <p class="text-black text-sm font-medium mb-1">${product.name}</p>
                                <p class="text-black text-sm">Giá: ${product.price.toLocaleString()} đ</p>
                            </div>
                        `).join('')}
                    </div>
                `;
      container.appendChild(categoryDiv);
    });
  }

  // Render hóa đơn
  function renderInvoice() {
    const tbody = document.getElementById('invoiceItems');
    tbody.innerHTML = '';
    orderItems.forEach(item => {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-gray-100';
      tr.innerHTML = `
                    <td class="py-2 text-sm">${item.product.name}</td>
                    <td class="py-2 text-sm">
                        <input type="number" value="${item.quantity}" readonly class="w-12 text-center border border-gray-300 rounded px-1 bg-gray-50 cursor-not-allowed" min="0">
                    </td>
                    <td class="py-2 text-sm">${item.product.price.toLocaleString()} đ</td>
                    <td class="py-2 text-sm">${(item.product.price * item.quantity).toLocaleString()} đ</td>
                    <td class="py-2">
                        <button onclick="openConfirmModal('${item.product.id}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
      tbody.appendChild(tr);
    });
    const totalAmount = orderItems.reduce((sum, item) => sum + item.product.price * item.quantity, 0);
    document.getElementById('totalAmount').textContent = `Tổng tiền (số): ${totalAmount.toLocaleString()} đ`;
    document.getElementById('totalInWords').textContent = `Tổng tiền (chữ): ${numberToWords(totalAmount)}`;
    localStorage.setItem('currentOrder', JSON.stringify(orderItems));
  }

  // Mở modal thêm sản phẩm
  function openProductModal(productId) {
    selectedProduct = products.find(p => p.id === productId);
    if (!selectedProduct) return;
    document.getElementById('modalProductImage').src = selectedProduct.image || '/placeholder.svg';
    document.getElementById('modalProductName').textContent = selectedProduct.name;
    document.getElementById('modalProductPrice').textContent = `Giá: ${selectedProduct.price.toLocaleString()} đ`;
    document.getElementById('modalQuantity').value = 1;
    document.getElementById('addProductModal').classList.remove('hidden');
  }

  // Thêm sản phẩm vào hóa đơn
  function addToOrder(product, quantity) {
    const existingItem = orderItems.find(item => item.product.id === product.id);
    if (existingItem) {
      existingItem.quantity += quantity;
    } else {
      orderItems.push({ product, quantity });
    }
    renderInvoice();
  }

  // Xử lý xác nhận modal thêm sản phẩm
  document.getElementById('confirmModalBtn').addEventListener('click', () => {
    const quantity = parseInt(document.getElementById('modalQuantity').value) || 1;
    if (quantity > 0) {
      addToOrder(selectedProduct, quantity);
      document.getElementById('addProductModal').classList.add('hidden');
      selectedProduct = null;
    }
  });

  // Hủy modal thêm sản phẩm
  document.getElementById('cancelModalBtn').addEventListener('click', () => {
    document.getElementById('addProductModal').classList.add('hidden');
    selectedProduct = null;
  });

  // Mở modal xác nhận xóa
  function openConfirmModal(productId) {
    selectedItemToRemove = orderItems.find(item => item.product.id === productId);
    if (!selectedItemToRemove) return;
    document.getElementById('confirmRemoveText').textContent = `Bạn có chắc chắn muốn xóa: x${selectedItemToRemove.quantity} ${selectedItemToRemove.product.name} không?`;
    document.getElementById('confirmRemoveModal').classList.remove('hidden');
  }

  // Xác nhận xóa sản phẩm
  document.getElementById('confirmRemoveBtn').addEventListener('click', () => {
    orderItems = orderItems.filter(item => item.product.id !== selectedItemToRemove.product.id);
    renderInvoice();
    document.getElementById('confirmRemoveModal').classList.add('hidden');
    selectedItemToRemove = null;
  });

  // Hủy modal xóa
  document.getElementById('cancelRemoveBtn').addEventListener('click', () => {
    document.getElementById('confirmRemoveModal').classList.add('hidden');
    selectedItemToRemove = null;
  });

  // Mở modal hủy đơn
  document.getElementById('cancelOrderBtn').addEventListener('click', () => {
    document.getElementById('cancelOrderModal').classList.remove('hidden');
  });

  // Xác nhận hủy đơn
  document.getElementById('confirmCancelOrderBtn').addEventListener('click', () => {
    orderItems = [];
    localStorage.setItem('currentOrder', JSON.stringify(orderItems));
    window.location.href = 'QLbanhang.html';
  });

  // Hủy modal hủy đơn
  document.getElementById('cancelCancelOrderBtn').addEventListener('click', () => {
    document.getElementById('cancelOrderModal').classList.add('hidden');
  });

  // Xử lý thanh toán
  document.getElementById('paymentBtn').addEventListener('click', () => {
    const currentDate = new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
    const invoice = {
      id: Date.now().toString(),
      date: currentDate,
      items: orderItems.map(item => ({ ...item.product, quantity: item.quantity })),
      total: orderItems.reduce((sum, item) => sum + item.product.price * item.quantity, 0)
    };
    localStorage.setItem('pendingInvoice', JSON.stringify(invoice));
    window.location.href = 'xacnhanthanhtoan.html';
  });

  // Tìm kiếm sản phẩm
  document.getElementById('searchInput').addEventListener('input', (e) => {
    searchTerm = e.target.value;
    renderProducts();
  });

  // Khởi tạo
  init();
</script>
</body>
</html>