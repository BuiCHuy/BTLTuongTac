<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FiveH Tạo Hóa Đơn</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    #root { height: 100vh; }
    .full-height { min-height: calc(100vh - 200px); }
    .scrollable { max-height: 400px; overflow-y: auto; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const FiveHPOS = () => {
      const [searchTerm, setSearchTerm] = useState("");
      const [orderItems, setOrderItems] = useState(
        JSON.parse(localStorage.getItem('currentOrder')) || [
          { product: { id: "4", name: "Trà sữa matcha", price: 20000, image: "", category: "Đồ uống" }, quantity: 2 },
          { product: { id: "1", name: "Trà sữa trân châu", price: 20000, image: "", category: "Đồ uống" }, quantity: 1 },
        ]
      );
      const [txtSearch, setTxtSearch] = useState();
      const [products, setProducts] = useState([]);
      const [showModal, setShowModal] = useState(false);
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [modalQuantity, setModalQuantity] = useState(1);
      const [showConfirmModal, setShowConfirmModal] = useState(false);
      const [selectedItemToRemove, setSelectedItemToRemove] = useState(null);
      const [showCancelOrderModal, setShowCancelOrderModal] = useState(false);
      const [inputField, setInputField] = useState("");
      const [txtNotify, setTxtNotify] = useState("Bỏ trống số lượng sẽ là 1");
      const [colorTxtNotify, setColorTxtNotify] = useState("text-sm text-center mb-4 pt-5");

      useEffect(() => {
        fetch('products.json')
          .then(response => response.json())
          .then(data => setProducts(data))
          .catch(error => console.error('Error fetching products:', error));
        localStorage.setItem('currentOrder', JSON.stringify(orderItems));
      }, [orderItems]);

      const confirmNextTab = () => {
        alert("Bạn vui lòng tạo xong hóa đơn hoặc hủy hóa đơn để có thể chuyển trang")
      }
      const handleInputChange = (e) => {
        const value = e.target.value;
        setTxtSearch(value);
      };
      
      const confirmTimKiem = () => {
        setSearchTerm(txtSearch);
      }

      const openProductModal = (product) => {
        setSelectedProduct(product);
        setModalQuantity(1);
        setShowModal(true);
      };

      const addToOrder = (product, quantity = 1) => {
        const existingItem = orderItems.find((item) => item.product.id === product.id);
        if (existingItem) {
          setOrderItems(
            orderItems.map((item) =>
              item.product.id === product.id ? { ...item, quantity: item.quantity + quantity } : item
            )
          );
        } else {
          setOrderItems([...orderItems, { product, quantity }]);
        }
      };

      const handleConfirmModal = () => {
        if(txtNotify == "Không được nhập số âm"){
          return;
        }
        if (selectedProduct) {
          addToOrder(selectedProduct, modalQuantity);
          setShowModal(false);
          setSelectedProduct(null);
          setModalQuantity(1);
          setInputField("");
        }
      };

      const handleCancelModal = () => {
        setShowModal(false);
        setSelectedProduct(null);
        setModalQuantity(1);
        setInputField("");
      };

      const removeFromOrder = (productId) => {
        setOrderItems(orderItems.filter((item) => item.product.id !== productId));
      };

      const confirmRemove = () => {
        if (selectedItemToRemove) {
          removeFromOrder(selectedItemToRemove.product.id);
          setShowConfirmModal(false);
          setSelectedItemToRemove(null);
        }
      };

      const cancelRemove = () => {
        setShowConfirmModal(false);
        setSelectedItemToRemove(null);
      };

      const openConfirmModal = (item) => {
        setSelectedItemToRemove(item);
        setShowConfirmModal(true);
      };

      const confirmCancelOrder = () => {
        setOrderItems([]);
        setShowCancelOrderModal(false);
        window.location.href = 'PageQLBH.html';

      };

      const cancelCancelOrder = () => {
        setShowCancelOrderModal(false);
      };

      const openCancelOrderModal = () => {
        setShowCancelOrderModal(true);
      };

      const totalAmount = orderItems.reduce((sum, item) => sum + item.product.price * item.quantity, 0);

      const handlePayment = () => {
        const currentDate = new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
        const invoice = {
          id: Date.now().toString(),
          date: currentDate,
          items: orderItems.map(item => ({ ...item.product, quantity: item.quantity })),
          total: totalAmount,
        };

        localStorage.setItem('pendingInvoice', JSON.stringify(invoice));
        window.location.href = 'xacnhanthanhtoan.html';
      };

      function numberToWords(num) {
        const units = ["", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín"];
        const tens = ["", "mười", "hai mươi", "ba mươi", "bốn mươi", "năm mươi", "sáu mươi", "bảy mươi", "tám mươi", "chín mươi"];
        const thousands = ["", "nghìn", "triệu", "tỷ"];

        if (num === 0) return "không đồng";

        let result = "";
        let thousandIndex = 0;

        while (num > 0) {
          let part = num % 1000;
          if (part > 0) {
            let partStr = "";
            let hundred = Math.floor(part / 100);
            let ten = Math.floor((part % 100) / 10);
            let unit = part % 10;

            if (hundred > 0) {
              partStr += units[hundred] + " trăm";
            }

            if (ten > 1) {
              partStr += (partStr ? " " : "") + tens[ten];
              if (unit > 0) partStr += " " + units[unit];
            } else if (ten === 1) {
              partStr += (partStr ? " " : "") + "mười";
              if (unit > 0) partStr += " " + units[unit];
            } else if (unit > 0) {
              partStr += (partStr ? " " : "") + units[unit];
            }

            result = partStr + (thousands[thousandIndex] ? " " + thousands[thousandIndex] : "") + (result ? " " : "") + result;
          }
          num = Math.floor(num / 1000);
          thousandIndex++;
        }

        return result.trim() + " đồng";
      }

      const filteredProducts = products.filter((product) => 
        product.name.toLowerCase().includes(searchTerm.toLowerCase())
      );

      const groupedProducts = filteredProducts.reduce((acc, product) => {
        if (!acc[product.category]) {
          acc[product.category] = [];
        }
        acc[product.category].push(product);
        return acc;
      }, {});

      return (
        <div className="min-h-screen bg-gray-100">
          <header className="bg-white shadow-sm px-6 py-4 flex items-center justify-between">
            <h1 className="text-2xl font-bold text-black">FiveH</h1>
            <div className="flex items-center space-x-6">
              <div className="flex items-center space-x-2 cursor-pointer">
                <i className="fas fa-cog text-gray-600 text-lg"></i>
                <span className="text-gray-700">Cài đặt</span>
              </div>
              <div className="flex items-center space-x-3">
                <div className="w-10 h-10 bg-gray-300 rounded-full"></div>
                <div className="flex flex-col">
                  <span className="text-gray-700 font-medium">Quản lý</span>
                  <span className="text-gray-500 text-sm cursor-pointer">Đăng xuất</span>
                </div>
              </div>
            </div>
          </header>

          <nav className="bg-gradient-to-r from-purple-600 to-pink-500 px-6 py-3">
            <div className="flex items-center justify-between text-white">
              {[
                { icon: "fa-home", label: "Trang chủ", active: false },
                { icon: "fa-shopping-cart", label: "Bán hàng", active: true },
                { icon: "fa-users", label: "Nhân viên", active: false },
                { icon: "fa-box", label: "Mặt hàng", active: false },
                { icon: "fa-tags", label: "CT Khuyến mại", active: false },
                { icon: "fa-chart-line", label: "Doanh thu", active: false },
              ].map((item, index) => (
                <div
                  onClick={confirmNextTab}
                  key={index}
                  className={`flex items-center space-x-2 cursor-pointer hover:text-pink-100 transition-colors ${
                    item.active ? "text-pink-100" : ""
                  }`}
                >
                  <i className={`fas ${item.icon} text-lg`}></i>
                  <span className="font-medium">{item.label}</span>
                </div>
              ))}
            </div>
          </nav>

          <div className="p-6">
            <h1 className="text-3xl font-bold text-black mb-6">Tạo hóa đơn</h1>

            <div className="flex gap-1">
              <div className="w-1/2 border border-gray-300 rounded-l-lg p-4 bg-white">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-bold text-black">Mặt hàng</h2>
                  
                  <div class="flex items-center space-x-4">
                    <div class="relative">
                      <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên" class="w-96 px-4 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-600"
                      onChange={handleInputChange}
                      />
                      <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button onClick={confirmTimKiem} class="bg-purple-600 text-white px-4 py-2 rounded-md shadow-lg hover:bg-purple-700 hover:shadow-xl transform hover:-translate-y-px transition-all flex items-center space-x-2">
                    <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>

                <div className="max-h-96 overflow-y-auto">
                  {Object.entries(groupedProducts).map(([category, categoryProducts]) => (
                    <div key={category} className="mb-6">
                      <div className="border-t border-gray-300 pt-2 mb-4">
                        <h3 className="text-lg font-bold text-black">{category}</h3>
                      </div>
                      <div className="grid grid-cols-3 gap-4">
                        {categoryProducts.map((product) => (
                          <div
                            key={product.id}
                            className="bg-white border border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition-shadow"
                            onClick={() => openProductModal(product)}
                          >
                            <img
                              src={product.image}
                              alt={product.name}
                              className="w-full h-32 object-cover rounded mb-2"
                            />
                            <p className="text-black text-sm font-medium mb-1">{product.name}</p>
                            <p className="text-black text-sm">Giá: {product.price.toLocaleString()} đ</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="w-1/2 border border-gray-300 border-l-0 rounded-r-lg p-4 bg-white relative">
                <h2 className="text-xl font-bold text-black mb-4">Hóa đơn</h2>

                <div className="bg-white border border-gray-200 rounded-lg p-4">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b border-gray-200">
                        <th className="text-left py-2 text-sm font-medium">Mặt hàng</th>
                        <th className="text-left py-2 text-sm font-medium">Số lượng</th>
                        <th className="text-left py-2 text-sm font-medium">Đơn giá</th>
                        <th className="text-left py-2 text-sm font-medium">Thành tiền</th>
                        <th className="w-8"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {orderItems.map((item) => (
                        <tr key={item.product.id} className="border-b border-gray-100">
                          <td className="py-2 text-sm">{item.product.name}</td>
                          <td className="py-2 text-sm">
                            <input
                              type="number"
                              value={item.quantity}
                              readOnly
                              className="w-12 text-center border border-gray-300 rounded px-1 bg-gray-50 cursor-not-allowed"
                              min="0"
                            />
                          </td>
                          <td className="py-2 text-sm">{item.product.price.toLocaleString()} đ</td>
                          <td className="py-2 text-sm">{(item.product.price * item.quantity).toLocaleString()} đ</td>
                          <td className="py-2">
                            <button
                              onClick={() => openConfirmModal(item)}
                              className="text-red-500 hover:text-red-700"
                            >
                              <i className="fas fa-trash"></i>
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>

                  <div className="mt-4 space-y-1 text-right">
                    <p className="text-sm">Tổng tiền (số)  : {totalAmount.toLocaleString()} đ</p>
                    <p className="text-sm">Tổng tiền (chữ)  : {numberToWords(totalAmount)}</p>
                  </div>
                </div>

                <div className="absolute bottom-0 right-4 flex gap-10 text-white p-2 pr-70">
                  <div className="flex justify-end gap-2 mt-4">
                    <button 
                      className="bg-white border border-black text-black w-[150px] h-8 text-sm rounded flex items-center justify-center gap-5"
                      onClick={openCancelOrderModal}
                    >
                      <i className="fas fa-times"></i> Hủy đơn
                    </button>
                    <button 
                      className="bg-black border border-black text-white w-[150px] h-8 text-sm rounded flex items-center justify-center gap-5"
                      onClick={handlePayment}
                    >
                      <i className="fas fa-check"></i> Thanh toán
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {showModal && selectedProduct && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 w-[100] max-w-md mx-4">
                <h3 className="text-xl font-bold text-center mb-4">Điền số lượng</h3>

                <div className="flex justify-between gap-2 mt-4">
                  <div className="flex justify-center mb-6 pl-8">
                    <div className="text-center">
                      <img
                        src={selectedProduct.image || "/placeholder.svg"}
                        alt={selectedProduct.name}
                        className="w-32 h-32 object-cover rounded mb-2 mx-auto"
                      />
                      <p className="text-sm font-medium">{selectedProduct.name}</p>
                      <p className="text-sm text-gray-600">Giá: {selectedProduct.price.toLocaleString()} đ</p>
                    </div>
                  </div>

                  <div className="flex flex-col items-center justify-center mb-6">
                    <input
                      type="number"
                      value={inputField}
                      onChange={(e) => {
                        const value = e.target.value;
                        if(value == ""){
                          setModalQuantity(1);
                          setInputField("");
                        }
                        else if(value.includes("-")){
                          setInputField(value);
                          setColorTxtNotify("text-sm text--600 text-center mb-4 pt-5 text-red-500");
                          setTxtNotify("Không được nhập số âm");
                        }
                        else{
                          setInputField(value);
                          setTxtNotify("Bỏ trống số lượng sẽ là 1");
                          setColorTxtNotify("text-sm text-center mb-4 pt-5");
                            setModalQuantity(parseInt(value));
                        }
                      }}
                      className="w-20 h-10 text-center border border-gray-300 rounded px-1"
                      min="0"
                    />
                    <p className={colorTxtNotify}>{txtNotify}</p>
                  </div>
                </div>
                

                <div className="flex gap-3">
                  <button 
                    className="bg-white border border-black text-black w-[150px] h-8 text-sm rounded flex items-center justify-center gap-5"

                    onClick={handleCancelModal}
                  >
                    <i className="fas fa-times"></i> Hủy
                  </button>
                  <button 
                    className="bg-black border border-black text-white w-[150px] h-8 text-sm rounded flex items-center justify-center gap-5"
                    onClick={handleConfirmModal}
                  >
                    <i className="fas fa-check"></i> Xác nhận
                  </button>
                </div>
              </div>
            </div>
          )}

          {showConfirmModal && selectedItemToRemove && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 w-96 max-w-md mx-4 text-center">
                <i class="fas fa-exclamation-triangle fa-2x text-yellow-600"></i>
                <h3 className="text-lg font-bold mb-4">
                  Bạn có chắc chắn muốn xóa: x{selectedItemToRemove.quantity} {selectedItemToRemove.product.name} không?
                </h3>
                <div className="flex justify-center gap-4">
                  <button
                    className="bg-black w-[100px] h-8 text-sm rounded flex items-center justify-center gap-2 text-white"
                    onClick={confirmRemove}
                  >
                    <i className="fas fa-check"></i> Có
                  </button>
                  <button
                    className="bg-white border border-black text-black w-[100px] h-8 text-sm rounded flex items-center justify-center gap-2"
                    onClick={cancelRemove}
                  >
                    <i className="fas fa-times"></i> Không
                  </button>
                </div>
              </div>
            </div>
          )}

          {showCancelOrderModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 w-96 max-w-md mx-4 text-center">
                <i class="fas fa-exclamation-triangle fa-2x text-yellow-600"></i>
                <h3 className="text-lg font-bold mb-4">Bạn có chắc chắn muốn hủy đơn?</h3>
                <div className="flex justify-center gap-4">
                  <button
                    className="bg-black w-[100px] h-8 text-sm rounded flex items-center justify-center gap-2 text-white"
                    onClick={confirmCancelOrder}
                  >
                    <i className="fas fa-check"></i> Có
                  </button>
                  <button
                    className="bg-white border border-black text-black w-[100px] h-8 text-sm rounded flex items-center justify-center gap-2"
                    onClick={cancelCancelOrder}
                  >
                    <i className="fas fa-times"></i> Không
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<FiveHPOS />, document.getElementById('root'));
  </script>
</body>
</html>